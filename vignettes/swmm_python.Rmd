---
title: "SWMM Python"
author: "Michael Rustler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SWMM Python}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Prerequisites 

Install [Anaconda](https://www.anaconda.com/products/individual) on your computer
(**requires admin rights!**): 
[https://www.anaconda.com/products/individual#Downloads](https://www.anaconda.com/products/individual#Downloads)

Or [Miniconda](https://docs.conda.io/en/latest/miniconda.html) with `reticulate::install_miniconda()` (no admin rights required).

For this tutorial [Miniconda](https://docs.conda.io/en/latest/miniconda.html) is 
used.

## Setup environment 

Setup an environment named `swmm` for where we want to install [pyswmm](https://pyswmm.readthedocs.io/en/latest/) 

```{r setup_pyswmm, eval = FALSE}

### Install miniconda

reticulate::install_miniconda()


### Create python environment 
env_name <- "swmm"

### Use Python 3.8 (as for 3.9 installation of "pyswmm" requires 
### Microsoft Visual Studio 2017: "Building windows wheels for Python 3.9 requires 
### Microsoft Visual Studio 2017 Get it with "Visual Studio 2017ยง

reticulate::conda_create(env_name, packages = "python=3.8")

################################################################################
### Install "pyswmm" (v1.0.1 available, status:2021-01-25)
### https://pypi.org/project/pyswmm/ 
################################################################################
reticulate::use_miniconda(condaenv = env_name, required = TRUE)

pyconfig <- reticulate::py_config()

reticulate::use_python(python = pyconfig$python, required = TRUE)

## on windows: (try this: https://github.com/rstudio/reticulate/issues/367#issuecomment-432920802)
if(.Platform$OS.type == "windows") {
  Sys.setenv(PATH= paste(PATH = pyconfig$pythonpath, 
                         Sys.getenv()["PATH"], sep=";")
  )
  Sys.setenv(RETICULATE_PYTHON = pyconfig$python)
}

reticulate::py_install(packages = "pyswmm", 
                       envname = env_name, 
                       pip = TRUE, 
                       pip_ignore_installed = TRUE)

### Downgrade dependency "aenam" to get rid of error: 
### reticulate::import("pyswmm") 
### Error in py_module_import(module, convert = convert) : 
### NameError: name 'US' is not defined
### https://github.com/OpenWaterAnalytics/pyswmm/issues/272#issuecomment-782697886
### should be fixed in next release of "swmm-toolkit" (v0.9.0)
### https://github.com/OpenWaterAnalytics/swmm-python/pull/67

reticulate::conda_install(envname = env_name, 
                          packages = "aenum=2.2.6")

# indicate that we want to use a specific condaenv
reticulate::use_miniconda(condaenv = env_name, required = TRUE)

reticulate::py_config()

pyswmm <- reticulate::import("pyswmm", convert = TRUE)


### check pyswmm version (should be v1.0.1 as installed using "pip") 
#pyswmm$VERSION_INFO

################################################################################
### Install "pyswmm" (v0.6.2 available, status:2021-01-25)
### https://pypi.org/project/pyswmm/ 
################################################################################

reticulate::conda_create("swmm_conda", packages = c("python=3.8", "pyswmm"))

reticulate::use_miniconda(condaenv = "swmm", required = TRUE)
reticulate::use_python(pyconfig$python)
pyswmm <- reticulate::import("pyswmm")
swmm <- reticulate::import("swmm", convert = TRUE)

res <- pyswmm$Simulation(inputfile = "neubrand.INP",  reportfile = "report.rpt", outputfile = "output.out", swmm_lib_path = "C:/_UserProg/EPA SWMM 5.1.013/")
#Fehler in py_module_import(module, convert = convert) : 
# ImportError: DLL load failed while importing _solver: 
# The entered module was not found.
```
Give up for now due to the `ImportError: DLL load failed while importing _solver`

## Dependencies

### R  

```
sessioninfo::session_info()
- Session info -------------------------------------------------------------------------------------------
 setting  value                       
 version  R version 4.0.4 (2021-02-15)
 os       Windows 10 x64              
 system   x86_64, mingw32             
 ui       RStudio                     
 language (EN)                        
 collate  German_Germany.1252         
 ctype    German_Germany.1252         
 tz       Europe/Berlin               
 date     2021-03-25                  

- Packages -----------------------------------------------------------------------------------------------
 package     * version date       lib source        
 assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.0.2)
 cli           2.3.1   2021-02-23 [1] CRAN (R 4.0.2)
 digest        0.6.27  2020-10-24 [1] CRAN (R 4.0.3)
 evaluate      0.14    2019-05-28 [1] CRAN (R 4.0.2)
 glue          1.4.2   2020-08-27 [1] CRAN (R 4.0.2)
 htmltools     0.5.1.1 2021-01-22 [1] CRAN (R 4.0.3)
 jsonlite      1.7.2   2020-12-09 [1] CRAN (R 4.0.3)
 knitr         1.31    2021-01-27 [1] CRAN (R 4.0.4)
 lattice       0.20-41 2020-04-02 [1] CRAN (R 4.0.3)
 Matrix        1.3-2   2021-01-06 [2] CRAN (R 4.0.4)
 rappdirs      0.3.3   2021-01-31 [1] CRAN (R 4.0.3)
 Rcpp          1.0.6   2021-01-15 [1] CRAN (R 4.0.3)
 reticulate    1.18    2020-10-25 [1] CRAN (R 4.0.3)
 rlang         0.4.10  2020-12-30 [1] CRAN (R 4.0.3)
 rmarkdown     2.7     2021-02-19 [1] CRAN (R 4.0.4)
 sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 4.0.3)
 withr         2.4.1   2021-01-26 [1] CRAN (R 4.0.3)
 xfun          0.22    2021-03-11 [1] CRAN (R 4.0.4)
 yaml          2.2.1   2020-02-01 [1] CRAN (R 4.0.2)

[1] C:/Users/mrustl/Documents/R/win-library/4.0
[2] C:/Program Files/R/R-4.0.4/library

```

### Conda Environment Yaml 

pyswmm v1.0.1 (from [PyPi](https://pypi.org/project/pyswmm/))

```
name: swmm_pypi
channels:
  - conda-forge
  - defaults
dependencies:
  - aenum=2.2.6=pyhd3deb0d_0
  - alabaster=0.7.12=pyhd3eb1b0_0
  - appdirs=1.4.4=py_0
  - argh=0.26.2=py38_0
  - astroid=2.5=py38haa95532_1
  - async_generator=1.10=pyhd3eb1b0_0
  - atomicwrites=1.4.0=py_0
  - attrs=20.3.0=pyhd3eb1b0_0
  - autopep8=1.5.6=pyhd3eb1b0_0
  - babel=2.9.0=pyhd3eb1b0_0
  - backcall=0.2.0=pyhd3eb1b0_0
  - bcrypt=3.2.0=py38he774522_0
  - black=19.10b0=py_0
  - bleach=3.3.0=pyhd3eb1b0_0
  - brotlipy=0.7.0=py38h2bbff1b_1003
  - ca-certificates=2021.1.19=haa95532_1
  - certifi=2020.12.5=py38haa95532_0
  - cffi=1.14.5=py38hcd4344a_0
  - chardet=4.0.0=py38haa95532_1003
  - click=7.1.2=pyhd3eb1b0_0
  - cloudpickle=1.6.0=py_0
  - colorama=0.4.4=pyhd3eb1b0_0
  - cryptography=3.4.6=py38h71e12ea_0
  - decorator=4.4.2=pyhd3eb1b0_0
  - defusedxml=0.7.1=pyhd3eb1b0_0
  - diff-match-patch=20200713=py_0
  - docutils=0.16=py38_1
  - entrypoints=0.3=py38_0
  - flake8=3.9.0=pyhd3eb1b0_0
  - future=0.18.2=py38_1
  - icu=58.2=ha925a31_3
  - idna=2.10=pyhd3eb1b0_0
  - imagesize=1.2.0=pyhd3eb1b0_0
  - importlib-metadata=3.7.3=py38haa95532_1
  - importlib_metadata=3.7.3=hd3eb1b0_1
  - intervaltree=3.1.0=py_0
  - ipykernel=5.3.4=py38h5ca1d4c_0
  - ipython=7.21.0=py38hd4e2768_0
  - ipython_genutils=0.2.0=pyhd3eb1b0_1
  - isort=5.8.0=pyhd3eb1b0_0
  - jedi=0.17.2=py38haa95532_1
  - jinja2=2.11.3=pyhd3eb1b0_0
  - jpeg=9b=hb83a4c4_2
  - jsonschema=3.2.0=py_2
  - jupyter_client=6.1.7=py_0
  - jupyter_core=4.7.1=py38haa95532_0
  - jupyterlab_pygments=0.1.2=py_0
  - keyring=22.3.0=py38haa95532_0
  - lazy-object-proxy=1.6.0=py38h2bbff1b_0
  - libpng=1.6.37=h2a8f88b_0
  - libsodium=1.0.18=h62dcd97_0
  - libspatialindex=1.9.3=h6c2663c_0
  - markupsafe=1.1.1=py38he774522_0
  - mccabe=0.6.1=py38_1
  - mistune=0.8.4=py38he774522_1000
  - mypy_extensions=0.4.3=py38_0
  - nbclient=0.5.3=pyhd3eb1b0_0
  - nbconvert=6.0.7=py38_0
  - nbformat=5.1.2=pyhd3eb1b0_1
  - nest-asyncio=1.5.1=pyhd3eb1b0_0
  - numpydoc=1.1.0=pyhd3eb1b0_1
  - openssl=1.1.1k=h2bbff1b_0
  - packaging=20.9=pyhd3eb1b0_0
  - pandoc=2.12=haa95532_0
  - pandocfilters=1.4.3=py38haa95532_1
  - paramiko=2.7.2=py_0
  - parso=0.7.0=py_0
  - pathspec=0.7.0=py_0
  - pexpect=4.8.0=pyhd3eb1b0_3
  - pickleshare=0.7.5=pyhd3eb1b0_1003
  - pip=21.0.1=pyhd8ed1ab_0
  - pluggy=0.13.1=py38haa95532_0
  - prompt-toolkit=3.0.17=pyh06a4308_0
  - psutil=5.8.0=py38h2bbff1b_1
  - ptyprocess=0.7.0=pyhd3eb1b0_2
  - pycodestyle=2.6.0=pyhd3eb1b0_0
  - pycparser=2.20=py_2
  - pydocstyle=6.0.0=pyhd3eb1b0_0
  - pyflakes=2.2.0=pyhd3eb1b0_0
  - pygments=2.8.1=pyhd3eb1b0_0
  - pylint=2.7.2=py38haa95532_1
  - pyls-black=0.4.6=hd3eb1b0_0
  - pyls-spyder=0.3.2=pyhd3eb1b0_0
  - pynacl=1.4.0=py38h62dcd97_1
  - pyopenssl=20.0.1=pyhd3eb1b0_1
  - pyparsing=2.4.7=pyhd3eb1b0_0
  - pyqt=5.9.2=py38ha925a31_4
  - pyrsistent=0.17.3=py38he774522_0
  - pysocks=1.7.1=py38haa95532_0
  - python=3.8.8=h7840368_0_cpython
  - python-dateutil=2.8.1=pyhd3eb1b0_0
  - python-jsonrpc-server=0.4.0=py_0
  - python-language-server=0.36.2=pyhd3eb1b0_0
  - python_abi=3.8=1_cp38
  - pytz=2021.1=pyhd3eb1b0_0
  - pywin32=227=py38he774522_1
  - pywin32-ctypes=0.2.0=py38_1000
  - pyyaml=5.4.1=py38h2bbff1b_1
  - pyzmq=20.0.0=py38hd77b12b_1
  - qdarkstyle=2.8.1=py_0
  - qt=5.9.7=vc14h73c81de_0
  - qtawesome=1.0.2=pyhd3eb1b0_0
  - qtconsole=5.0.2=pyhd3eb1b0_0
  - qtpy=1.9.0=py_0
  - regex=2021.3.17=py38h2bbff1b_0
  - requests=2.25.1=pyhd3eb1b0_0
  - rope=0.18.0=py_0
  - rtree=0.9.4=py38h21ff451_1
  - setuptools=49.6.0=py38haa244fe_3
  - sip=4.19.13=py38ha925a31_0
  - six=1.15.0=py38haa95532_0
  - snowballstemmer=2.1.0=pyhd3eb1b0_0
  - sortedcontainers=2.3.0=pyhd3eb1b0_0
  - sphinx=3.5.3=pyhd3eb1b0_0
  - sphinxcontrib-applehelp=1.0.2=pyhd3eb1b0_0
  - sphinxcontrib-devhelp=1.0.2=pyhd3eb1b0_0
  - sphinxcontrib-htmlhelp=1.0.3=pyhd3eb1b0_0
  - sphinxcontrib-jsmath=1.0.1=pyhd3eb1b0_0
  - sphinxcontrib-qthelp=1.0.3=pyhd3eb1b0_0
  - sphinxcontrib-serializinghtml=1.1.4=pyhd3eb1b0_0
  - spyder=4.2.4=py38haa95532_0
  - spyder-kernels=1.10.2=py38haa95532_0
  - sqlite=3.35.2=h8ffe710_0
  - testpath=0.4.4=pyhd3eb1b0_0
  - textdistance=4.2.1=pyhd3eb1b0_0
  - three-merge=0.1.1=pyhd3eb1b0_0
  - toml=0.10.2=pyhd3eb1b0_0
  - tornado=6.1=py38h2bbff1b_0
  - traitlets=5.0.5=pyhd3eb1b0_0
  - typed-ast=1.4.2=py38h2bbff1b_1
  - typing_extensions=3.7.4.3=pyha847dfd_0
  - ujson=4.0.2=py38hd77b12b_0
  - urllib3=1.26.4=pyhd3eb1b0_0
  - vc=14.2=hb210afc_4
  - vs2015_runtime=14.28.29325=h5e1d092_4
  - watchdog=1.0.2=py38haa95532_1
  - wcwidth=0.2.5=py_0
  - webencodings=0.5.1=py38_1
  - wheel=0.36.2=pyhd3deb0d_0
  - win_inet_pton=1.1.0=py38haa95532_0
  - wincertstore=0.2=py38haa244fe_1006
  - wrapt=1.12.1=py38he774522_1
  - yaml=0.2.5=he774522_0
  - yapf=0.31.0=pyhd3eb1b0_0
  - zeromq=4.3.3=ha925a31_3
  - zipp=3.4.1=pyhd3eb1b0_0
  - zlib=1.2.11=h62dcd97_4
  - pip:
    - pyswmm==1.0.1
    - swmm-toolkit==0.8.1
prefix: C:\Users\mrustl\.conda\envs\swmm
```

**pyswmm v0.6.2** (from [conda-forge](https://anaconda.org/conda-forge/pyswmm))

```
name: swmm_conda
channels:
  - conda-forge
  - defaults
dependencies:
  - ca-certificates=2020.12.5=h5b45459_0
  - certifi=2020.12.5=py38haa244fe_1
  - llvm-openmp=8.0.1=h1ad3211_0
  - openmp=8.0.1=0
  - openssl=1.1.1k=h8ffe710_0
  - pip=21.0.1=pyhd8ed1ab_0
  - pyswmm=0.6.2=pyh9f0ad1d_1
  - python=3.8.8=h7840368_0_cpython
  - python_abi=3.8=1_cp38
  - setuptools=49.6.0=py38haa244fe_3
  - six=1.15.0=pyh9f0ad1d_0
  - sqlite=3.35.2=h8ffe710_0
  - swmm=5.2.1=ha925a31_1
  - vc=14.2=hb210afc_4
  - vs2015_runtime=14.28.29325=h5e1d092_4
  - wheel=0.36.2=pyhd3deb0d_0
  - wincertstore=0.2=py38haa244fe_1006
prefix: C:\Users\mrustl\.conda\envs\swmm_conda
```
